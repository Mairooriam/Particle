cmake_minimum_required(VERSION 3.10)
project(hotreload_testing C)

set(CMAKE_C_COMPILER "clang-cl")

set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Wextra -Wpedantic -fdiagnostics-color=always")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic -fdiagnostics-color=always")
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-gnu-zero-variadic-macro-arguments")  # Suppress ##__VA_ARGS__ warning
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-newline-eof")               # Suppress newline at EOF warnings
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-unused-function")           # Suppress unused function warnings
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-unsafe-buffer-usage")   
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-implicit-int-enum-cast")  
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-implicit-void-ptr-cast")    # Suppress implicit void* to pointer cast warnings
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -w")   


set(CMAKE_TOOLCHAIN_FILE "C:/vcpkg/scripts/buildsystems/vcpkg.cmake" CACHE STRING "VCPKG toolchain file")
set(VCPKG_MANIFEST_MODE ON)

add_library(entity_lib STATIC
    entity/pool/entityPool.c
)
find_package(Vulkan REQUIRED)
find_package(glfw3 CONFIG REQUIRED)

target_include_directories(entity_lib PUBLIC 
    ${CMAKE_CURRENT_SOURCE_DIR}/entity
    ${CMAKE_CURRENT_SOURCE_DIR}/entity/pool
)

add_executable(engine
    engine/raylib_platform.c
    engine/vulkanLayer.c
)

target_include_directories(engine PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/entity
    ${CMAKE_CURRENT_SOURCE_DIR}/entity/pool
    ${CMAKE_CURRENT_SOURCE_DIR}/shared
)

target_link_libraries(engine PRIVATE
    glfw
    Vulkan::Vulkan
    cglm # REMOVE THIS IN FUTURE
    winmm
)


# DLL
add_library(application SHARED
    app/application.c
    app/spatialGrid.c
)

target_include_directories(application PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/shared
)

target_link_libraries(application PRIVATE
    entity_lib
)

set_target_properties(application PROPERTIES OUTPUT_NAME "application_being_written")

target_compile_definitions(application PRIVATE INTERNAL_BUILD)
target_compile_definitions(engine PRIVATE INTERNAL_BUILD)

if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_compile_definitions(entity_lib PRIVATE SLOW_CODE_ALLOWED ENTITY_POOL_DEVELOPMENT)
    target_compile_definitions(engine PRIVATE SLOW_CODE_ALLOWED)
    target_compile_definitions(application PRIVATE SLOW_CODE_ALLOWED)
endif()



add_custom_command(TARGET application POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy application_being_written.dll application.dll
    COMMAND ${CMAKE_COMMAND} -E remove application_being_written.dll
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    VERBATIM
)
